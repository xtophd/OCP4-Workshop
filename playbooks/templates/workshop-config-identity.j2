#!/bin/bash

export KUBECONFIG={{ workshop_extras.ocp_creds_dir }}/auth/kubeconfig

echo ""
echo "Set password for {{ workshop_vars.ocp_user }}"
echo "---------------------------"

htpasswd /usr/local/etc/workshop-users.htpasswd {{ workshop_vars.ocp_user }}

echo ""
echo "Creating/Updating openshift htpass-secret"
echo "-----------------------------------------"

if `oc create secret generic htpass-secret --from-file=htpasswd=/usr/local/etc/workshop-users.htpasswd -n openshift-config > /dev/null 2>&1` ; then
  echo "Identity secret created"
else
  oc create secret generic htpass-secret --from-file=htpasswd=/usr/local/etc/workshop-users.htpasswd --dry-run -o yaml -n openshift-config 2>/dev/null | oc replace -f - > /dev/null 2>&1
  echo "Identity secret replaced"
fi

echo ""
echo "Configuring Identity Provider (HTPASSWD)"
echo "----------------------------------------"

oc apply -f /usr/local/etc/workshop-identity.yaml

echo ""
echo "Applying cluster-admin role to {{ workshop_vars.ocp_user }}"
echo "-------------------------------------------------"
oc adm policy add-cluster-role-to-user cluster-admin {{ workshop_vars.ocp_user }} 
